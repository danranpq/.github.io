<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text and Image Layout Generator</title>
  <style>
    /* 全局样式重置 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'URWGroteskWid-Lig', sans-serif;
      background-color: #fff;
    }

    h1 {
      text-align: center;
      margin: 20px 0;
      font-size: 28px;
    }

    /* 核心布局容器：总宽 1800px，高度 920px */
    .content-area {
      width: 1800px;
      height: 920px;
      margin: 0 auto;
      position: relative;
      border: 1px solid #ccc;
      overflow: hidden;
    }

    /* 带内边距的内容容器：左右内边距 50px，间距 100px */
    .padding-area {
      padding: 50px; /* 上下左右内边距 50px */
      height: 100%;
      width: 100%;
      display: flex;
      gap: 100px; /* 左右列间距 100px */
      box-sizing: border-box; /* 确保内边距算入总宽 */
    }

    /* 左右列容器：各 800px 宽，无额外内边距 */
    .left-container,
    .right-container {
      width: 800px;
      height: 100%;
      overflow: hidden;
      box-sizing: border-box;
      padding: 0; /* 清除默认内边距 */
      margin: 0; /* 清除默认外边距 */
    }

    /* 图片容器：水平居中，与文本间距 20px */
    .image-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 20px; /* 图片与文本的间距 */
    }

    /* 图片占位：两种尺寸 */
    .image-placeholder {
      width: 800px;
      height: 460px;
      background-color: #ddd;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: #666;
    }
    .image-placeholder.small {
      width: 370px;
      height: 370px;
    }

    /* 文本区域：填充满父容器，控制文本样式 */
    .text-area {
      width: 100%;
      font-size: 41px;
      line-height: 50px;
      letter-spacing: 0px;
      word-wrap: break-word;
      /* 如需文本与容器边缘间距，可在此添加 */
      /* padding: 0 20px; */
    }

    /* 段落样式：统一间距 */
    .paragraph {
      margin-bottom: 30px;
    }
    .paragraph:last-child {
      margin-bottom: 0;
    }

    /* 控制面板样式 */
    .control-panel {
      width: 1800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #f5f5f5;
      border-radius: 5px;
    }
    .row {
      display: flex;
      gap: 20px;
    }
    .column {
      flex: 1;
    }
    textarea {
      width: 100%;
      height: 400px;
      padding: 10px;
      font-size: 16px;
      line-height: 1.5;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #165DFF;
      color: white;
    }
    button:hover {
      background-color: #0E42CC;
    }
    .checkbox-group {
      margin-bottom: 20px;
    }

    /* 隐藏测量容器：用于计算文本高度 */
    #measureContainer {
      position: absolute;
      visibility: hidden;
      width: 800px;
      font-size: 41px;
      line-height: 50px;
      word-wrap: break-word;
      top: -1000px;
      box-sizing: border-box;
    }
    #measureContainer .paragraph {
      margin-bottom: 30px;
    }
    #measureContainer .paragraph:last-child {
      margin-bottom: 0;
    }

    /* 加载指示器 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <h1>Text and Image Layout Generator</h1>

  <!-- 核心布局展示区域 -->
  <div class="content-area">
    <div id="layoutDisplay" class="padding-area">
      Please enter text and click "Generate Layout" to view the result
    </div>
  </div>

  <!-- 控制面板 -->
  <div class="control-panel">
    <div class="row">
      <div class="column">
        <label for="textInput">Enter Text</label><br>
        <textarea id="textInput" placeholder="Enter text content. Paragraphs will be automatically separated by line breaks">It was their first No-Screen Saturday. Mum had been to a meeting about using electronic devices safely and decided that they all looked at their devices too much.

"We used to talk more and play games as a family. Now we stare at screens," said Mum.

At the beginning, everyone found it difficult. Dad had caught Mum checking her messages that morning. "It’s work!" she explained, quickly putting her phone away.

"Let’s have breakfast," Dad said, sitting at the table.

"What’s that on your lap?" Ken asked.

"Nothing," Dad muttered as he slid the tablet in a drawer.

Zac wanted to finish his game and kept complaining. Mum put more toast on his plate and impatiently told him, "There is more to life than computer games."</textarea>
      </div>
      <div class="column">
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="hasImage" checked> Include Image
          </label>
        </div>
        <div class="checkbox-group" id="imageSizeGroup">
          <label>
            <input type="checkbox" id="useSmallImage"> Use small image (370x370)
          </label>
        </div>
        <button id="generateBtn">
          <span id="buttonText">Generate Layout</span>
          <span id="loadingIndicator" class="loading" style="display:none;"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- 文本高度测量容器 -->
  <div id="measureContainer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 按设计图比例缩放（可选）
      document.body.style.zoom = "33%"; 

      const generateBtn = document.getElementById('generateBtn');
      const textInput = document.getElementById('textInput');
      const hasImage = document.getElementById('hasImage');
      const useSmallImage = document.getElementById('useSmallImage');
      const imageSizeGroup = document.getElementById('imageSizeGroup');
      const layoutDisplay = document.getElementById('layoutDisplay');
      const measureContainer = document.getElementById('measureContainer');
      const buttonText = document.getElementById('buttonText');
      const loadingIndicator = document.getElementById('loadingIndicator');

      let fontLoaded = false;

      // 字体加载检测
      function checkFontLoaded() {
        const testElement = document.createElement('span');
        testElement.style.position = 'absolute';
        testElement.style.visibility = 'hidden';
        testElement.style.fontFamily = 'sans-serif';
        testElement.style.fontSize = '20px';
        testElement.textContent = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        
        const referenceElement = testElement.cloneNode(true);
        referenceElement.style.fontFamily = 'URWGroteskWid-Lig, sans-serif';
        
        document.body.appendChild(testElement);
        document.body.appendChild(referenceElement);
        
        const isLoaded = testElement.offsetWidth !== referenceElement.offsetWidth;
        document.body.removeChild(testElement);
        document.body.removeChild(referenceElement);
        return isLoaded;
      }

      function waitForFontLoad() {
        return new Promise((resolve) => {
          if (checkFontLoaded()) {
            fontLoaded = true;
            resolve(true);
            return;
          }
          const interval = setInterval(() => {
            if (checkFontLoaded()) {
              clearInterval(interval);
              fontLoaded = true;
              resolve(true);
            }
          }, 100);
          setTimeout(() => {
            clearInterval(interval);
            console.warn('Font did not load within 3 seconds, using fallback');
            resolve(false);
          }, 3000);
        });
      }

      // 图片尺寸选择联动
      hasImage.addEventListener('change', function () {
        imageSizeGroup.style.display = this.checked ? 'block' : 'none';
      });

      // 生成布局逻辑
      generateBtn.addEventListener('click', async function() {
        buttonText.textContent = 'Generating...';
        loadingIndicator.style.display = 'inline-block';
        generateBtn.disabled = true;
        
        try {
          await waitForFontLoad();
          generateLayout();
        } finally {
          buttonText.textContent = 'Generate Layout';
          loadingIndicator.style.display = 'none';
          generateBtn.disabled = false;
        }
      });

      // 测量文本高度（严格匹配文本区域样式）
      function measureTextHeight(paragraphs) {
        measureContainer.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'text-area';
        paragraphs.forEach((para) => {
          const paraElement = document.createElement('div');
          paraElement.className = 'paragraph';
          paraElement.textContent = para;
          container.appendChild(paraElement);
        });
        measureContainer.appendChild(container);
        container.offsetHeight; // 触发重排
        return container.offsetHeight;
      }

      // 布局计算（确保宽度正确）
      function calculateLayout(paragraphs, hasImage, useSmallImage) {
        if (!hasImage || paragraphs.length === 0) {
          const midPoint = Math.ceil(paragraphs.length / 2);
          return {
            type: 'no_image',
            left_paras: paragraphs.slice(0, midPoint),
            right_paras: paragraphs.slice(midPoint),
            useSmallImage: false
          };
        }

        const imageHeight = useSmallImage ? 370 : 460;
        const imageGap = 20;
        const totalHeight = 920;
        const paddingTopBottom = 50 * 2;
        const leftAvailableHeight = totalHeight - paddingTopBottom - imageHeight - imageGap; 

        const leftParas = [];
        const rightParas = [];

        let currentHeight = 0;
        for (let i = 0; i < paragraphs.length; i++) {
          const tempParas = [...leftParas, paragraphs[i]];
          const tempHeight = measureTextHeight(tempParas);
          
          if (tempHeight <= leftAvailableHeight + 30) { 
            leftParas.push(paragraphs[i]);
            currentHeight = tempHeight;
          } else {
            rightParas.push(...paragraphs.slice(i));
            break;
          }
        }

        if (rightParas.length === 0 && leftParas.length === paragraphs.length) {
          const midPoint = Math.ceil(leftParas.length / 2);
          return {
            type: 'image_with_text',
            left_paras: leftParas.slice(0, midPoint),
            right_paras: leftParas.slice(midPoint),
            useSmallImage: useSmallImage
          };
        }

        return {
          type: 'image_with_text',
          left_paras: leftParas,
          right_paras: rightParas,
          useSmallImage: useSmallImage
        };
      }

      // 渲染段落（填充满父容器）
      function renderParagraphs(paragraphs) {
        if (!paragraphs || paragraphs.length === 0) return null;
        const textArea = document.createElement('div');
        textArea.className = 'text-area';
        paragraphs.forEach(para => {
          const paraElement = document.createElement('div');
          paraElement.className = 'paragraph';
          paraElement.textContent = para;
          textArea.appendChild(paraElement);
        });
        return textArea;
      }

      // 渲染布局（确保容器宽度正确）
      function renderLayout(layout) {
        const container = document.createElement('div');
        container.className = 'padding-area';

        const imageClass = layout.useSmallImage ? 'image-placeholder small' : 'image-placeholder';

        // 左列容器
        const leftContainer = document.createElement('div');
        leftContainer.className = 'left-container';

        // 图片容器
        const imageContainer = document.createElement('div');
        imageContainer.className = 'image-container';
        imageContainer.innerHTML = `<div class="${imageClass}">image</div>`;
        leftContainer.appendChild(imageContainer);

        // 左列文本
        const leftText = renderParagraphs(layout.left_paras);
        leftContainer.appendChild(leftText);

        // 右列容器
        const rightContainer = document.createElement('div');
        rightContainer.className = 'right-container';

        // 右列文本
        const rightText = renderParagraphs(layout.right_paras);
        rightContainer.appendChild(rightText);

        container.appendChild(leftContainer);
        container.appendChild(rightContainer);
        layoutDisplay.innerHTML = '';
        layoutDisplay.appendChild(container);
      }
    });
  </script>
</body>

</html>
